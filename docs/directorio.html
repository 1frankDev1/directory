<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio - Pastel Directory</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .business-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 2rem;
        }
        .business-card {
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .business-card:hover { transform: translateY(-5px); }
        .business-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .search-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: -2rem;
            display: flex;
            gap: 10px;
        }
        .category-filter {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }
        .cat-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid var(--primary);
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
        }
        .cat-btn.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" id="logo">Pastel Directory</a>
            <nav id="nav-links">
                <a href="index.html">Inicio</a>
                <a href="directorio.html">Explorar</a>
                <span id="auth-links">
                    <a href="login.html">Entrar</a>
                </span>
            </nav>
        </div>
    </header>

    <div class="hero" style="padding: 3rem 0;">
        <div class="container">
            <h1>Encuentra lo que buscas</h1>
        </div>
    </div>

    <main class="container">
        <div id="search-view">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar negocio..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                <button class="btn btn-primary" onclick="loadBusinesses()">Buscar</button>
            </div>

            <div id="category-list" class="category-filter">
                <!-- Categories will load here -->
            </div>

            <div id="business-results" class="business-list">
                <!-- Businesses will load here -->
            </div>
        </div>

        <div id="profile-view" class="hidden">
            <!-- Business profile details will load here -->
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Pastel Directory. Hecho con amor.</p>
        </div>
    </footer>

    <div id="toast" class="hidden"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/helpers.js"></script>
    <script src="js/auth-check.js"></script>
    <script>
        let currentCategory = null;

        async function loadCategories() {
            const { data: categories } = await supabaseClient.from('categories').select('*');
            const catList = document.getElementById('category-list');
            catList.innerHTML = `<button class="cat-btn active" onclick="filterCategory(null, this)">Todos</button>`;
            categories?.forEach(cat => {
                catList.innerHTML += `<button class="cat-btn" onclick="filterCategory('${cat.id}', this)">${cat.name}</button>`;
            });
        }

        async function filterCategory(id, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCategory = id;
            loadBusinesses();
        }

        async function loadBusinesses() {
            const queryText = document.getElementById('search-input').value;
            let query = supabaseClient.from('businesses').select('*');

            if (currentCategory) query = query.eq('category_id', currentCategory);
            if (queryText) query = query.ilike('name', `%${queryText}%`);

            const { data: businesses } = await query;
            const results = document.getElementById('business-results');

            if (!businesses || businesses.length === 0) {
                results.innerHTML = '<p class="text-center" style="grid-column: 1/-1; padding: 3rem;">No se encontraron negocios.</p>';
                return;
            }

            results.innerHTML = businesses.map(b => `
                <div class="card business-card" onclick="viewProfile('${b.id}')">
                    <img src="${b.logo_url || 'https://via.placeholder.com/300x180?text=Negocio'}" alt="${b.name}">
                    <h3 style="margin-top: 1rem;">${b.name}</h3>
                    <p class="text-muted" style="font-size: 0.9rem;">${b.address || 'Sin direcci√≥n'}</p>
                </div>
            `).join('');
        }

        async function viewProfile(id) {
            window.location.hash = `profile=${id}`;
            renderProfile(id);
        }

        async function trackEvent(businessId, eventType) {
            await supabaseClient.from('statistics').insert([
                { business_id: businessId, event_type: eventType, user_id: currentUser?.id }
            ]);
        }

        async function renderProfile(id) {
            document.getElementById('search-view').classList.add('hidden');
            const profileView = document.getElementById('profile-view');
            profileView.classList.remove('hidden');
            profileView.innerHTML = '<p>Cargando perfil...</p>';

            const { data: b } = await supabaseClient.from('businesses').select('*, categories(name)').eq('id', id).single();
            const { data: services } = await supabaseClient.from('services').select('*').eq('business_id', id).eq('is_active', true);
            const { data: reviews } = await supabaseClient.from('reviews').select('*, profiles(full_name)').eq('business_id', id);

            let isFav = false;
            if (currentUser) {
                const { data: fav } = await supabaseClient.from('favorites').select('*').eq('business_id', id).eq('user_id', currentUser.id).maybeSingle();
                isFav = !!fav;
            }

            trackEvent(id, 'profile_view');

            profileView.innerHTML = `
                <button class="btn btn-outline mb-4" onclick="closeProfile()">‚Üê Volver al listado</button>
                <div class="card">
                    <div style="height: 200px; background: var(--pastel-blue); border-radius: 12px; overflow: hidden;">
                        <img src="${b.banner_url || 'https://via.placeholder.com/1000x200'}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div class="flex" style="margin-top: -50px; padding: 0 2rem; align-items: flex-end; justify-content: space-between;">
                        <div class="flex" style="align-items: flex-end;">
                            <img src="${b.logo_url || 'https://via.placeholder.com/100'}" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; background: white;">
                            <div style="margin-left: 1rem; margin-bottom: 10px;">
                                <h1 style="font-size: 2rem;">${b.name}</h1>
                                <span class="badge" style="background: var(--pastel-pink); padding: 4px 10px; border-radius: 20px;">${b.categories?.name || 'Negocio'}</span>
                            </div>
                        </div>
                        <button class="btn ${isFav ? 'btn-primary' : 'btn-outline'}" onclick="toggleFav('${b.id}', ${isFav})">
                            ${isFav ? '‚ù§Ô∏è Favorito' : 'ü§ç Guardar'}
                        </button>
                    </div>

                    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 2rem;">
                        <div>
                            <h2>Sobre nosotros</h2>
                            <p style="margin-top: 1rem;">${b.description || 'Sin descripci√≥n disponible.'}</p>

                            <h2 style="margin-top: 2rem;">Servicios</h2>
                            <div class="grid gap-4 mt-2">
                                ${services?.map(s => `
                                    <div class="card flex" style="justify-content: space-between; align-items: center; border: 1px solid #eee; padding: 1rem;">
                                        <div><strong>${s.name}</strong></div>
                                        <span style="font-weight: 800; color: var(--primary);">${helpers.formatCurrency(s.price)}</span>
                                    </div>
                                `).join('') || '<p>No hay servicios listados.</p>'}
                            </div>

                            <h2 style="margin-top: 2rem;">Rese√±as</h2>
                            <div class="mt-4">
                                ${reviews?.map(r => `
                                    <div class="card" style="padding: 1rem; margin-bottom: 1rem; background: #fcfcfc;">
                                        <div class="flex" style="justify-content: space-between;">
                                            <strong>${r.profiles?.full_name || 'An√≥nimo'}</strong>
                                            <span style="color: #fbbf24;">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</span>
                                        </div>
                                        <p style="margin-top: 0.5rem;">${r.comment}</p>
                                    </div>
                                `).join('') || '<p>No hay rese√±as a√∫n. ¬°S√© el primero!</p>'}
                            </div>

                            ${currentUser ? `
                                <div class="card mt-4" style="background: var(--pastel-pink);">
                                    <h3>Deja tu opini√≥n</h3>
                                    <form onsubmit="handleReview(event, '${b.id}')">
                                        <div class="form-group mt-2">
                                            <label>Calificaci√≥n</label>
                                            <select id="rev-rating"><option value="5">5 ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option><option value="4">4 ‚òÖ‚òÖ‚òÖ‚òÖ</option><option value="3">3 ‚òÖ‚òÖ‚òÖ</option><option value="2">2 ‚òÖ‚òÖ</option><option value="1">1 ‚òÖ</option></select>
                                        </div>
                                        <div class="form-group">
                                            <label>Comentario</label>
                                            <textarea id="rev-comment" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Publicar</button>
                                    </form>
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <div class="card" style="background: #f8fafc; position: sticky; top: 100px;">
                                <h3>Contacto</h3>
                                <p style="margin-top: 1rem;">üìç ${b.address || 'Sin direcci√≥n'}</p>
                                <div class="flex gap-2" style="flex-direction: column; margin-top: 1rem;">
                                    ${b.phone ? `<button onclick="trackEvent('${b.id}', 'call_click'); window.location.href='tel:${b.phone}'" class="btn btn-primary text-center">üìû Llamar</button>` : ''}
                                    ${b.whatsapp ? `<button onclick="trackEvent('${b.id}', 'whatsapp_click'); window.open('https://wa.me/${b.whatsapp}', '_blank')" class="btn" style="background: #25d366; color: white; text-align: center;">üí¨ WhatsApp</button>` : ''}
                                    ${b.website ? `<button onclick="trackEvent('${b.id}', 'web_click'); window.open('${b.website}', '_blank')" class="btn btn-outline text-center">üåê Sitio Web</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function toggleFav(bizId, currentlyFav) {
            if (!currentUser) return alert('Inicia sesi√≥n para guardar favoritos');
            if (currentlyFav) {
                await supabaseClient.from('favorites').delete().eq('business_id', bizId).eq('user_id', currentUser.id);
            } else {
                await supabaseClient.from('favorites').insert([{ business_id: bizId, user_id: currentUser.id }]);
            }
            renderProfile(bizId);
        }

        async function handleReview(e, bizId) {
            e.preventDefault();
            const rating = parseInt(document.getElementById('rev-rating').value);
            const comment = document.getElementById('rev-comment').value;
            const { error } = await supabaseClient.from('reviews').insert([{
                business_id: bizId, user_id: currentUser.id, rating, comment
            }]);
            if (error) alert('Ya has dejado una rese√±a para este negocio.');
            else renderProfile(bizId);
        }

        function closeProfile() {
            window.location.hash = '';
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('search-view').classList.remove('hidden');
        }

        window.onload = async () => {
            await loadCategories();
            const hash = window.location.hash;
            if (hash.startsWith('#profile=')) {
                renderProfile(hash.split('=')[1]);
            } else {
                loadBusinesses();
            }
        };
    </script>
</body>
</html>
